---
title: "Live API Tests"
output: html_document
---

# Testing the live API calls

Use `.Renviron` to set the API key and base URL, for example:

```
SYNTHESIZE_API_KEY <- your - api - key - here
SYNTHESIZE_API_BASE_URL=https://app.synthesize.bio
```

## Setup (Run Once)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load all R source files
for (f in list.files("R", pattern = "\\.R$", full.names = TRUE)) {
    source(f)
}

# Load test dependencies
library(testthat)
library(jsonlite)
library(httr)

# Load helper functions
source("tests/testthat/helper-mocks.R")

# Helper function for API key checking
check_api_key <- function() {
    key <- Sys.getenv("SYNTHESIZE_API_KEY")
    !is.na(key) && key != ""
}

# Get API base URL from environment or use default
get_api_base_url <- function() {
    url <- Sys.getenv("SYNTHESIZE_API_BASE_URL")
    if (url == "") "http://localhost" else url
}
```

## Configuration Check

```{r check-config}
if (!check_api_key()) {
  stop("SYNTHESIZE_API_KEY not set. Please configure .Renviron")
}

api_url <- get_api_base_url()
message("Using API base URL: ", api_url)
```

## Test: List Models

```{r test-list-models}
test_that("list_models live API call", {
  skip_if_not(check_api_key(),
              "SYNTHESIZE_API_KEY is not set")

  models <- list_models(api_base_url = api_url)

  expect_type(models, "list")
  expect_true(length(models) > 0)

  model_ids <- sapply(models, function(m) m$model_id)
  expect_true("gem-1-bulk" %in% model_ids)
  expect_true("gem-1-sc" %in% model_ids)

  message(sprintf("✓ Retrieved %d models", length(models)))
})
```

## Test: Example Queries

```{r test-example-queries}
test_that("get_example_query for multiple models", {
  skip_if_not(check_api_key(),
              "SYNTHESIZE_API_KEY is not set")

  models_to_test <- c("gem-1-bulk", "gem-1-sc")

  for (model_id in models_to_test) {
    query <- get_example_query(model_id = model_id,
                               api_base_url = api_url)

    expect_type(query$example_query, "list")
    expect_true("inputs" %in% names(query$example_query))

    message(sprintf("✓ Retrieved example query for %s", model_id))
  }
})
```

## Test: Reference Conditioning Models

```{r test-reference-conditioning}
test_that("predict_query for reference conditioning models", {
  skip_if_not(check_api_key(),
              "SYNTHESIZE_API_KEY is not set")

  models_to_test <- c(
      "gem-1-bulk_reference-conditioning",
      "gem-1-sc_reference-conditioning"
  )

  for (model_id in models_to_test) {
    message(sprintf("\nTesting %s...", model_id))

    query <- get_example_query(model_id = model_id,
                               api_base_url = api_url)
    result <- predict_query(query = query$example_query,
                           model_id = model_id,
                           api_base_url = api_url)

    expect_type(result, "list")
    expect_true("metadata" %in% names(result),
        info = "Result should contain metadata"
    )
    expect_true("expression" %in% names(result),
        info = "Result should contain expression"
    )

    message(sprintf("✓ Prediction successful for %s", model_id))
  }
})
```

## Test: Metadata Prediction Models

```{r test-predict-metadata}
test_that("predict_query for metadata prediction models", {
  skip_if_not(check_api_key(),
              "SYNTHESIZE_API_KEY is not set")

  models_to_test <- c(
      "gem-1-bulk_predict-metadata",
      "gem-1-sc_predict-metadata"
  )

  for (model_id in models_to_test) {
    message(sprintf("\nTesting %s...", model_id))

    query <- get_example_query(model_id = model_id,
                               api_base_url = api_url)
    result <- predict_query(query = query$example_query,
                           model_id = model_id,
                           api_base_url = api_url)

    expect_type(result, "list")
    expect_true("metadata" %in% names(result),
                info = "Result should contain metadata")

    message(sprintf("✓ Prediction successful for %s", model_id))
  }
})
```

## Summary

Run all chunks sequentially or run individual chunks to test specific functionality. The setup chunk must be run first.
